= Hello Prod
:docinfo1:
:hardbreaks:
:sectanchors:
:sectnums:
:icons: font
:toc: left
:toc-title: Sommaire
:description: Hello Prod

== Design

=== Plan / Sizing

* https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/azure-subscription-service-limits#app-service-limits
=> Slot disponibles à partir du standard

* https://docs.microsoft.com/fr-fr/azure/postgresql/concepts-pricing-tiers
* https://docs.microsoft.com/fr-fr/azure/postgresql/concepts-limits
=> Garantie D'IOPS à partir de General Purpose

== Etapes de mise en oeuvre

* https://github.com/beeNotice/hello-prod[Application]
  ** https://spring.io/projects/spring-boot[Create Spring boot Application]
  ** https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html[Actuator]
* https://github.com/beeNotice/hello-prod-deploy[Initialisation de l'infrastructure]
* Déploiement
  ** https://github.com/actions/starter-workflows/blob/main/ci/azure.yml
  ** https://docs.microsoft.com/fr-fr/azure/app-service/deploy-container-github-action?tabs=service-principal
  ** Configuration applicative azurerm_app_service / app_settings pour utiliser le profil prod
* Hello Prod
  ** Ajout App Insight => Composant Terraform + Configuration azurerm_app_service / app_settings
  ** Ajout health check App Service
  ** Add log retention


== Application

=== Decisions

* Utilisation de logback-spring.xml pour la configuration des logs plutôt via via application.yml / Séparation configuration des logs
  ** https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-logging
* Utilisation du profile spring pour la gestion des configurations d'environnement / Fonctionnement spring-boot
  ** https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-external-config
* Utilisation .yml au lieu de .properties, question de goût !
  ** https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-external-config-yaml 
* Utilisation d'un principal de service pour le déploiement, au lieu de la préco d'utilisation du profile de publication
  ** Utilisation de la clé de publication de Git pose problème car elle change à chaque fois, il faudrait la mettre à jour dans Git en même temps que le provisionnement 
  ** Sans doute à revoir sur une cible ou l'on ne détruit pas tout à chaque fois, car ici on a un Principal de service qui possède des droits au niveau de la souscription
  ** https://docs.microsoft.com/fr-fr/azure/app-service/deploy-container-github-action?tabs=service-principal


=== Usage

[source,cmd]
----
# Hello
curl --location --request GET 'http://localhost:8080/hello-world?name=Lol'

# Actuator
curl --location --request GET 'http://localhost:8080/management'
----

== Annexes

=== Documentation

* https://docs.microsoft.com/fr-fr/azure/architecture/reference-architectures/app-service-web-app/basic-web-app[Architecture de référence]
* https://channel9.msdn.com/Shows/Azure-Friday/Operational-best-practices-for-web-apps-on-Azure-App-Service[App Service Operational best practices]

== TODO 

* Excel des conventions Azure
* Vérifier tous les paramètres spring-boot à activer sur production
* Sécurisation heatlh
* Utilisation des slots de déploiement => staging
* Key Vault
    ** https://docs.microsoft.com/en-us/java/api/overview/azure/spring-boot-starter-keyvault-secrets-readme?view=azure-java-stable
    ** https://docs.microsoft.com/en-us/azure/app-service/overview-managed-identity?tabs=dotnet
* Configuration Timezone Logs
* Log Analytics
* Création d'alertes 
  ** Sur des métriques / Dynamic ou threshold
  ** Sur des logs
* Lancement de smoke tests sur l'application déployées
* build.properties


https://channel9.msdn.com/Shows/Azure-Friday/Testing-in-production-with-Azure-App-Service : 8.26


